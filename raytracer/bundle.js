!function(t){var e={};function r(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=t,r.c=e,r.d=function(t,e,s){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(s,n,function(e){return t[e]}.bind(null,n));return s},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e){class r{constructor(t,e,r){this.x=t,this.y=e,this.z=r}static times(t,e){return new r(t*e.x,t*e.y,t*e.z)}static divide(t,e){return new r(t.x/e,t.y/e,t.z/e)}static minus(t,e){return new r(t.x-e.x,t.y-e.y,t.z-e.z)}static plus(t,e){return new r(t.x+e.x,t.y+e.y,t.z+e.z)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static mag(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)}static norm(t){return r.divide(t,r.mag(t))}static cross(t,e){return new r(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)}}class s{constructor(t,e,r){this.r=t,this.g=e,this.b=r}static scale(t,e){return new s(t*e.r,t*e.g,t*e.b)}static plus(t,e){return new s(t.r+e.r,t.g+e.g,t.b+e.b)}static times(t,e){return new s(t.r*e.r,t.g*e.g,t.b*e.b)}static toDrawingColor(t){let e=function(t){return t>1?1:t},r=Math.floor(255*e(t.r)),n=Math.floor(255*e(t.g)),i=Math.floor(255*e(t.b));return new s(r,n,i)}static get white(){return new s(1,1,1)}static get yellow(){return new s(1,1,0)}static get green(){return new s(0,1,0)}static get red(){return new s(1,0,0)}static get grey(){return new s(.5,.5,.5)}static get black(){return new s(0,0,0)}static get background(){return this.black}static get defaultColor(){return this.black}}class n{constructor(t,e){this.pos=t;let s=new r(0,-1,0);this.forward=r.norm(r.minus(e,this.pos)),this.right=r.times(1.5,r.norm(r.cross(this.forward,s))),this.up=r.times(1.5,r.norm(r.cross(this.forward,this.right)))}}class i{constructor(t,e,r){this.center=t,this.surface=r,this.radius2=e*e}normal(t){return r.norm(r.minus(t,this.center))}intersect(t){let e=r.minus(this.center,t.start),s=r.dot(e,t.dir),n=0;if(s>=0){let t=this.radius2-(r.dot(e,e)-s*s);t>=0&&(n=s-Math.sqrt(t))}return 0===n?null:{thing:this,ray:t,dist:n}}}class a{constructor(t,e,s){this.surface=s,this.normal=function(e){return t},this.intersect=function(s){let n=r.dot(t,s.dir);if(n>0)return null;return{thing:this,ray:s,dist:(r.dot(t,s.start)+e)/-n}}}}class o{static shinyColor(t){return class{static diffuse(e){return t}static specular(t){return s.white}static reflect(t){return.3}static get roughness(){return 10}}}static get shinyWhite(){return class{static diffuse(t){return s.grey}static specular(t){return s.white}static reflect(t){return.3}static get roughness(){return 10}}}static get shinyRed(){return class{static diffuse(t){return s.red}static specular(t){return s.white}static reflect(t){return.3}static get roughness(){return 50}}}static get computed(){return class{static checker(t){return(Math.floor(t.z/10)+Math.floor(t.x/10))%2!=0}static circle(t){return Math.sqrt(t.z**2+t.x**2)<700}static mixed(t){return this.checker(t)&&this.circle(t)}static selected(t){return this.checker(t)}static diffuse(t){return this.selected(t)?s.green:s.yellow}static specular(t){return s.white}static reflect(t){return this.selected(t)?1:.9}static get roughness(){return 150}}}}let{all:c}=document,u=c.canvas,l=u.getContext("2d"),h=new class{constructor(){this.maxDepth=3,this.rayCache={},this.cachingEnabled=!0,this.stats={rayCacheSize:0,reused:0}}intersections(t,e){let r=1/0,s=void 0;for(let n in e.things){let i=e.things[n].intersect(t);null!=i&&i.dist<r&&(s=i,r=i.dist)}return s}testRay(t,e){let r=this.intersections(t,e);return null!=r?r.dist:void 0}traceRay(t,e,r){let n,i=JSON.stringify(t);if(this.cachingEnabled&&i in this.rayCache)return this.stats.reused++,this.rayCache[i];let a=this.intersections(t,e);return n=void 0===a?s.background:this.shade(a,e,r),this.cachingEnabled&&(this.rayCache[i]=n,this.stats.rayCacheSize++),n}shade(t,e,n){let i=t.ray.dir,a=r.plus(r.times(t.dist,i),t.ray.start),o=t.thing.normal(a),c=r.minus(i,r.times(2,r.times(r.dot(o,i),o))),u=s.plus(s.background,this.getNaturalColor(t.thing,a,o,c,e)),l=n>=this.maxDepth?s.grey:this.getReflectionColor(t.thing,a,o,c,e,n);return s.plus(u,l)}getReflectionColor(t,e,r,n,i,a){return s.scale(t.surface.reflect(e),this.traceRay({start:e,dir:n},i,a+1))}getNaturalColor(t,e,n,i,a){let o=this;return a.lights.reduce(function(c,u){let l=r.minus(u.pos,e),h=r.norm(l),d=o.testRay({start:e,dir:h},a);if(void 0!==d&&d<=r.mag(l))return c;{let a=r.dot(h,n),o=a>0?s.scale(a,u.color):s.defaultColor,l=r.dot(h,r.norm(i)),d=l>0?s.scale(Math.pow(l,t.surface.roughness),u.color):s.defaultColor;return s.plus(c,s.plus(s.times(t.surface.diffuse(e),o),s.times(t.surface.specular(e),d)))}},s.defaultColor)}render(t,e,n,i){function a(t,e,s){return r.norm(r.plus(s.forward,r.plus(r.times(function(t){return(t-n/2)/2/n}(t),s.right),r.times(function(t){return-(t-i/2)/2/i}(e),s.up))))}for(let r=0;r<i;r++)for(let i=0;i<n;i++){let n=this.traceRay({start:t.camera.pos,dir:a(i,r,t.camera)},t,0),o=s.toDrawingColor(n);e.fillStyle="rgb("+String(o.r)+", "+String(o.g)+", "+String(o.b)+")",e.fillRect(i,r,i+1,r+1)}}},d=(t,e)=>h.render(function(t,e){let c=new r(t,8,e);return{things:[new a(new r(0,1,0),0,o.computed),new i(new r(0,2,0),2,o.shinyRed),new i(new r(0,3,4),1,o.shinyColor(s.grey)),new i(new r(0,3,-4),1,o.shinyColor(s.green)),new i(new r(4,3,0),1,o.shinyColor(s.black)),new i(new r(-4,3,0),1,o.shinyColor(s.yellow))],lights:[{pos:c,color:new s(1,1,1)},{pos:new r(0,6,0),color:new s(1,1,1)}],camera:new n(c,new r(0,5,0))}}(t,e),l,u.width,u.height),f=()=>c.cameraRotation.value/c.cameraRotation.max*Math.PI*2,g=()=>d(Math.cos(f())*c.cameraZoom.value*5,Math.sin(f())*c.cameraZoom.value*5);c.cameraRotation.oninput=c.cameraZoom.oninput=(()=>setTimeout(g)),g();let m=()=>{c.cameraRotation.value=parseInt(c.cameraRotation.value)+4,c.cameraRotation.value==c.cameraRotation.max&&(c.cameraRotation.value=c.cameraRotation.min),setTimeout(g),setTimeout(m,100)};m(),setInterval(()=>c.stats.innerHTML="rayCacheSize:"+h.stats.rayCacheSize+" reused:"+h.stats.reused,1500)}]);